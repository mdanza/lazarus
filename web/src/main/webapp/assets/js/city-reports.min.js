toastr.options={closeButton:false,debug:false,positionClass:"toast-top-right",onclick:null,showDuration:"300",hideDuration:"1000",timeOut:"5000",extendedTimeOut:"1000",showEasing:"swing",hideEasing:"linear",showMethod:"fadeIn",hideMethod:"fadeOut"};var servicesUrl;var mMap;var infoWindow;var obstacles=new Array();var stops=new Array();var selectedObstacleMarker;var selectedStopMarker;var greenIcon=new MQA.Icon("assets/images/green.png",20,20);var redIcon=new MQA.Icon("assets/images/red.png",20,20);var orangeIcon=new MQA.Icon("assets/images/orange.png",20,20);var showStops=true;var showObstacles=true;var obstaclesRequest;var stopsRequest;var loadingStreetOptions=false;var stopsPageNumber=-1;var finishedLoadingStops=false;var stopsLoadingTimer;$(document).ready(function(){servicesUrl=$("#servicesUrl").val();if($("#hiddenToken").val()==""){window.location.replace("index.jsp")}else{MQA.EventUtil.observe(window,"load",initializeMap);MQA.EventUtil.observe(window,"resize",initializeMap)}});function searchCoords(){form=$("#searchCoordinatesForm");url=form.attr("action");var b=$("#inputStreet").val();var a=$("#inputNumber").val();if(b===""){toastr.error("La calle no puede estar vacía");return}if(isNaN(parseInt(a))||parseInt(a)<1){toastr.error("Número de puerta no puede ser vacío ni menor a 1");return}$("#searchCoordsBtn").button("loading");$.ajax({url:url,type:"GET",headers:{Authorization:$("#hiddenToken").val()},data:{streetName:b,number:a,letter:$("#inputLetter").val()},success:function(e,f,d){jsonResponse=JSON.parse(e);if(jsonResponse.result=="OK"){var c=JSON.parse(jsonResponse.data.replace(/\bNaN\b/g,"null"));$("#coordinatesInput").val(c.x+","+c.y);$("#searchCoordsModal").modal("hide");$("#addObstacleModal").modal();$("#searchCoordsBtn").button("reset")}else{$("#searchCoordsBtn").button("reset");toastr.error("No se encontró la dirección ingresada")}}})}function addObstacle(){form=$("#addObstacleForm");url=form.attr("action");var c=$("#coordinatesInput").val();var a=$("#radiusInput").val();var b=$("#descriptionInput").val();if(isNaN(parseInt(a))||parseInt(a)<1){toastr.error("Radio debe ser mayor o igual a 1");return}if(b===""||b.length>120){toastr.error("Descripción no puede estar vacío y debe ser menor a 120 caracteres");return}$.ajax({url:url,type:"POST",headers:{Authorization:$("#hiddenToken").val()},data:{coordinates:c,radius:a,description:b},success:function(e,f,d){jsonResponse=JSON.parse(e);if(jsonResponse.result=="OK"){toastr.success("Agregado correctamente");$("#addObstacleModal").modal("hide");placeObstacle({lat:$("#coordinatesInput").val().split(",")[0],lng:$("#coordinatesInput").val().split(",")[1]},$("#descriptionInput").val(),parseInt($("#radiusInput").val()),jsonResponse.data)}else{toastr.error(jsonResponse.data)}}})}function initializeMap(){MQA.withModule("largezoom","insetmapcontrol","mousewheel","shapes",function(){var b={elt:document.getElementById("map_canvas"),zoom:13,latLng:{lat:-34.894573,lng:-56.153088},mtype:"map",bestFitMargin:0,zoomOnDoubleClick:true};mMap=new MQA.TileMap(b);mMap.addControl(new MQA.LargeZoom(),new MQA.MapCornerPlacement(MQA.MapCorner.TOP_LEFT,new MQA.Size(5,5)));var a={size:{width:150,height:125},zoom:3,mapType:"map",minimized:true};mMap.addControl(new MQA.InsetMapControl(a),new MQA.MapCornerPlacement(MQA.MapCorner.BOTTOM_RIGHT));mMap.enableMouseWheelZoom();MQA.EventManager.addListener(mMap,"click",function(c){$("#coordinatesInput").val(c.ll.getLatitude()+","+c.ll.getLongitude());$("#addObstacleModal").modal()});loadObstacles();stopsLoadingTimer=setInterval(loadStops,2000)})}function placeObstacle(a,b,e,d){marker=new MQA.Poi(a);marker.setRolloverContent(b);if(e!=null&&e>=40){var c=new MQA.CircleOverlay();c.radiusUnit="KM";c.radius=e/1000;c.shapePoints=[a.lat,a.lng];c.fillColor="#FF6600";c.fillColorAlpha=0.2;marker._myCircle=c;mMap.addShape(c)}else{marker._myCircle=null}marker._customId=d;obstacles.push(marker);addObstacleInfoWindow(marker);marker.setIcon(orangeIcon);mMap.addShape(marker)}function placeStop(a,d,c){var b;if(c){b=greenIcon}else{b=redIcon}marker=new MQA.Poi(a);marker.setIcon(b);marker._customId=d;marker._customActive=c;stops.push(marker);addStopInfoWindow(marker);mMap.addShape(marker)}function addObstacleInfoWindow(a){a.setInfoContentHTML('<button type="button" class="btn btn-danger" onclick="deleteObstacle();">Borrar obstáculo?</button>');MQA.EventManager.addListener(a,"rolloveropen",function(){selectedObstacleMarker=a})}function addStopInfoWindow(a){a.setInfoContentHTML('<button type="button" class="btn btn-danger" onclick="switchStopStatus();">Cambiar estado de la parada?</button>');MQA.EventManager.addListener(a,"rolloveropen",function(){selectedStopMarker=a})}function deleteObstacle(){marker=selectedObstacleMarker;$.ajax({url:servicesUrl+"/obstacles/"+marker._customId,type:"DELETE",headers:{Authorization:$("#hiddenToken").val()},success:function(b,c,a){jsonResponse=JSON.parse(b);if(jsonResponse.result=="OK"){toastr.success("Borrado correctamente");mMap.removeShape(marker);if(marker._myCircle!=null){mMap.removeShape(marker._myCircle)}obstacles.splice(obstacles.indexOf(marker),1)}else{toastr.error(jsonResponse.data)}}});return false}function switchStopStatus(){marker=selectedStopMarker;$.ajax({url:servicesUrl+"/bus/all/"+marker._customId,type:"POST",headers:{Authorization:$("#hiddenToken").val()},data:{active:!marker._customActive},success:function(b,c,a){jsonResponse=JSON.parse(b);if(jsonResponse.result=="OK"){toastr.success("Modificado correctamente");marker._customActive=!marker._customActive;if(marker._customActive){marker.setIcon(greenIcon)}else{marker.setIcon(redIcon)}}else{toastr.error(jsonResponse.data)}}});return false}function findObstacle(a){return findInArray(a,obstacles)}function findStop(a){return findInArray(a,stops)}function findInArray(c,b){for(var a in b){if(b[a].customId==c){return b[a]}}}function loadObstacles(){$("#switchObstacles").button("loading");obstaclesRequest=$.ajax({url:servicesUrl+"/obstacles",type:"GET",headers:{Authorization:$("#hiddenToken").val()},success:function(c,d,b){jsonResponse=JSON.parse(c);if(jsonResponse.result=="OK"){jsonData=JSON.parse(jsonResponse.data);for(var a in jsonData){jsonObstacle=jsonData[a];placeObstacle({lat:parseFloat(jsonObstacle.latitude),lng:parseFloat(jsonObstacle.longitude)},jsonObstacle.description,jsonObstacle.radius,jsonObstacle.id)}$("#switchObstacles").button("reset")}else{window.location.replace("index.jsp")}}})}function loadStops(){stopsPageNumber=stopsPageNumber+1;$("#switchStops").button("loading");stopsRequest=$.ajax({url:servicesUrl+"/bus/all/all-stops?page="+stopsPageNumber,type:"GET",headers:{Authorization:$("#hiddenToken").val()},success:function(c,d,b){jsonResponse=JSON.parse(c);if(jsonResponse.result=="OK"){jsonData=JSON.parse(jsonResponse.data);for(var a in jsonData){jsonStop=jsonData[a];placeStop({lat:parseFloat(jsonStop.latitude),lng:parseFloat(jsonStop.longitude)},jsonStop.locationCode,jsonStop.active)}}else{$("#switchStops").button("reset");clearInterval(stopsLoadingTimer)}}})}function showHideStops(){showStops=!showStops;if(showStops){$("#switchStops").html("Esconder paradas");for(var a in stops){if(stops[a]._customActive==true){stops[a].setIcon(greenIcon)}else{stops[a].setIcon(redIcon)}mMap.addShape(stops[a])}}else{$("#switchStops").html("Mostrar paradas");for(var a in stops){mMap.removeShape(stops[a])}}return false}function showHideObstacles(){showObstacles=!showObstacles;if(showObstacles){$("#switchObstacles").html("Esconder obstáculos");for(var a in obstacles){obstacles[a].setIcon(orangeIcon);mMap.addShape(obstacles[a]);if(obstacles[a]._myCircle!=null){mMap.addShape(obstacles[a]._myCircle)}}}else{$("#switchObstacles").html("Mostrar obstáculos");for(var a in obstacles){mMap.removeShape(obstacles[a]);if(obstacles[a]._myCircle!=null){mMap.removeShape(obstacles[a]._myCircle)}}}return false}function checkStreets(){var a=$("#inputStreet").val();$("#dropdownBtn").button("loading");if(a.length>2&&loadingStreetOptions==false){loadingStreetOptions=true;$.ajax({url:servicesUrl+"/addresses/possibleStreets",type:"GET",headers:{Authorization:$("#hiddenToken").val()},data:{name:a},success:function(e,f,d){jsonResponse=JSON.parse(e);if(jsonResponse.result=="OK"){jsonStreets=JSON.parse(jsonResponse.data);var b="";for(var c in jsonStreets){b+="<li><a href=\"javascript:clickedStreetOption('"+jsonStreets[c]+"');\"</a>"+jsonStreets[c]+"</li>"}$("#streetsDropdown").html(b);$("#dropdownBtn").button("reset");setTimeout(function(){$("#dropdownBtn").click()},500);loadingStreetOptions=false}else{toastr.error("No se encontraron calles que satisfagan su búsqueda");$("#dropdownBtn").button("reset")}}})}return false}function clickedStreetOption(a){$("#inputStreet").val(a)};